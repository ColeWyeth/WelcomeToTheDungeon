<!DOCTYPE html>

<html>

<head>
    <title>
        Welcome to the dungeon simulator
    </title>
    <style>
        canvas { border: 1px solid black; }
    </style>
</head>

<body>
    <h1>Welcome to the Dungeon!</h1>
    <p>Join/Create Game</p>
    <form onsubmit="return JoinGame(this);">
        <label for="GameID">Game ID:</label><br>
        <input type="text" id="GameID" name="GameID"><br>
        <label for="PlayerName">Player Name:</label><br>
        <input type="text" id="PlayerName" name="PlayerName"><br>
        <input type="submit" value="Submit">
    </form>
    <p>Add a new AI player</p>
    <form onsubmit="return AddAIPlayer(this);">
        <input type="radio" id="Random" value="Random" name="PlayerType">
        <label for="Random">Random</label><br>
        <input type="radio" id="Sarsa" value="Sarsa" name="PlayerType">
        <label for="Sarsa">Sarsa</label><br>
        <input type="submit" value="Submit">
    </form>
    <br>
    <form onsubmit="return StartGame();">
        <input type="submit" value="Start/Enter Game">
    </form>
    <canvas id="GameSimulator" width="800" height="600">
        failed to render Weclome to the Dungeon graphics
    </canvas>
    <script>
        console.log("Start of code");
        let gameID = null;
        let gameEntered = false;
        let playerName = null;
        let playerInd = null;
        let state = null;
        let old_state_string = null;
        let state_changed = false;
        let nameList = null;
        const canvas = document.getElementById('GameSimulator');
        const ctx = canvas.getContext('2d');
        ctx.font = '30px serif';
        ctx.fillStyle = 'blue';
        let scrollbox = {
            text: "",
            text_lines : [],
            lines_displayed: 15,
            px: 0,
            display(x,y,w,h){
                ctx.fillStyle = 'black';
                ctx.strokeRect(x,y,w,h);
                this.px = h/this.lines_displayed;
                ctx.font = String(this.px) + "px serif";
                this.text_lines = this.text.split(/\r?\n/);
                let highest_pos = this.text_lines.length-this.lines_displayed;
                for(let i = this.text_lines.length -1; i >= Math.max(0, highest_pos); i--){
                    ctx.fillText(this.text_lines[i], x, h+y-this.px*i);
                }
            }
        }

        function OpeningScreen(){ 
            console.log("Rendering Opening Screen...");
            ctx.fillText("Join a game to begin...", 0, 50);
        }
        function JoinGame(form){
            console.log("Setting Game ID");
            gameID = form.elements["GameID"].value;
            console.log("Setting Player Name");
            playerName = form.elements["PlayerName"].value;
            console.log("Sending a join game request");
            //$.post("/join_game", JSON.stringify({"GameID": gameID, "PlayerName": playerName}));
            let xhr = new XMLHttpRequest();
            xhr.open("POST", "http://127.0.0.1:5000/join_game", true);
            xhr.send(new FormData(form));
            return false;
        }
        function AddAIPlayer(form){
            console.log("Adding AI player.");
            let xhr = new XMLHttpRequest();
            xhr.open("POST", "http://127.0.0.1:5000/add_ai_player", true);
            formData = new FormData(form);
            formData.append("GameID", gameID);
            xhr.send(formData);
            return false;
        }
        function StartGame(form){
            console.log("Joining game");
            let xhr = new XMLHttpRequest();
            xhr.open("POST", "http://127.0.0.1:5000/start_game", true);
            formData = new FormData(); // form itself contains no info
            formData.append("GameID", gameID);
            xhr.send(formData);
            gameEntered = true;
            return false;
        }
        function ParseState(state_string){
            console.log("Parsing state");
            if (old_state_string !== state_string){
                old_state_string = state_string
                state = JSON.parse(state_string);
                state_changed = true;
            }
            return state
        }

        function GetNameList(){
            console.log("Getting player name list in index order");
            let xhr = new XMLHttpRequest();
             xhr.onreadystatechange = function(){
                if (xhr.readyState == 4){
                    nameList = JSON.parse(xhr.response);
                }
            }
            xhr.open('POST', "http://127.0.0.1:5000/player_names", false);
            formData = new FormData();
            formData.append("GameID", gameID);
            xhr.send(formData);
        }

        function UpdateState(){
            console.log("Updating state");
            let xhr = new XMLHttpRequest();
             xhr.onreadystatechange = function(){
                if (xhr.readyState == 4){
                    state = ParseState(xhr.response);
                }
            }
            xhr.open('POST', "http://127.0.0.1:5000/game_state", true);
            formData = new FormData();
            formData.append("GameID", gameID);
            xhr.send(formData);
        }

        function RenderPlayer(x, y, name, index, successes, failures, active){
            console.log("Rendering player " + name);
            ctx.font = '18px serif';
            ctx.fillStyle = 'black';
            x = x*canvas.width;
            y = y*canvas.height;
            ctx.fillText(name, x, y);
            ctx.fillText("Player number " + String(index), x, y + 18);
            ctx.fillText("Successes: " + String(successes), x, y+36);
            ctx.fillText("Failures: " + String(failures), x, y+54);
            ctx.fillText("Still in: " + String(active), x, y+72);
        }

        function RenderImage(name, x, y){
            ctx.fillStyle = 'black';
            ctx.font = '12px serif';
            ctx.fillText(name, x, y);
            const img = new Image();
            img.addEventListener('load', function(){
                ctx.drawImage(img, x, y+10, 100, 150);
            }, false);
            img.src = "DungeonImages/" + name.replace(/\s/g, "") + ".png";
        }

        function Render(state){
            ctx.clearRect(0,0,canvas.width,canvas.height);

            // Render deck
            ctx.fillStyle = 'gray';
            ctx.fillRect(canvas.width/4, 3*canvas.height/8, 100, 150);
            ctx.font = '20px serif';
            ctx.fillStyle = 'black';
            ctx.fillText("Deck: " + String(state.deck.length), canvas.width/4, 3*canvas.height/8);

            // Render dungeon
            ctx.fillStyle = 'gray';
            ctx.fillRect(3*canvas.width/5, 3*canvas.height/8, 100, 150);
            ctx.font = '20px serif';
            ctx.fillStyle = 'black';
            ctx.fillText("Dungeon: " + String(state.dungeon.length), 3*canvas.width/5, 3*canvas.height/8);

            // Render Player Scores
            playerNum = nameList.length
            for(let i = 0; i < playerNum; i++){
                if(nameList[i] == playerName){
                    playerInd = i;
                }
            }
            playerSeats = [[1/3, 4/5], [0, 1/2], [4/5, 1/2]];
            seat = null;
            curr_p_ind = 0;
            curr_p = null;
            for(let i = 0; i < playerNum; i++){
                seat = playerSeats[i];
                curr_p_ind = (playerInd+i)%playerNum;
                curr_p = state.players[curr_p_ind];
                RenderPlayer(seat[0], seat[1], nameList[curr_p_ind], curr_p_ind, curr_p.successes, curr_p.failures, curr_p.active);    
            }

            // Render game log
            scrollbox.text = state.log;
            scrollbox.display(11*canvas.width/20, 7*canvas.height/10, 9*canvas.width/20, 3*canvas.height/10);

            // Render Items
            items = state.hero.items;
            for(let i = 0; i < items.length; i++){
                RenderImage(items[i].name, 125*i, 10);
            }

            if(state.currTurn === playerInd){
                console.log("Monster drawn is " + String(state.monsterDrawn));

                // Render Monster
                if(state.monsterDrawn !== null){
                    RenderImage(state.monsterDrawn.name, 9*canvas.width/20, 3*canvas.height/8);
                }
            }
        }

        function draw(){
            if(gameEntered){
                console.log("Game has been joined, rendering...");
                if(gameID == null){
                    console.log("No valid game ID!");
                    ctx.fillText("Choose a game ID before joining!", 0, 100);
                }else{
                    function delay(time){
                        return new Promise(resolve => setTimeout(resolve,time));
                    }
                    delay(1000);
                    // Player order is needed for rendering
                    if(nameList === null){
                        GetNameList();
                    }
                    UpdateState();
                    if(state_changed){
                        Render(state);
                        state_changed = false;
                    }
                }
            }else{
                OpeningScreen();
            }
            requestAnimationFrame(draw);
        }

        draw();
    </script>
</body>



</html>